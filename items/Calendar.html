<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>万年历</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="../css/theme.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            --surface-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --inner-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        body {
            height: 100vh;
            padding: var(--spacing-md);
            background-color: var(--background-primary);
            color: var(--text-primary);
            font-family: var(--font-family);
            line-height: 1.4;
            display: flex;
            justify-content: center;
            align-items: stretch;
            overflow: hidden;
            margin: 0;
            box-sizing: border-box;
        }

        .calendar-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: var(--spacing-lg);
            box-shadow: var(--surface-shadow);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* 标题样式 */
        h1 {
            text-align: center;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-md) 0;
            font-size: 24px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            letter-spacing: -0.5px;
            flex-shrink: 0;
        }

        h1 i {
            color: var(--primary-color);
            background: -webkit-linear-gradient(45deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* 控制面板样式 */
        .control-panel {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--background-primary);
            border-radius: var(--radius-md);
            flex-wrap: nowrap;
            gap: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .date-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            flex-wrap: nowrap;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            background: var(--background-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        .control-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(var(--primary-rgb), 0.2);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .quick-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .today-btn {
            width: auto;
            padding: 0 var(--spacing-md);
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
            gap: 6px;
        }

        .today-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
        }

        /* 日历网格样式 */
        .calendar-grid {
            background: var(--background-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--background-tertiary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .calendar-header-cell {
            padding: var(--spacing-sm);
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calendar-header-cell.weekend {
            color: var(--error-color);
        }

        .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            flex: 1;
            min-height: 0;
        }

        .calendar-cell {
            border-right: 1px solid var(--border-light);
            border-bottom: 1px solid var(--border-light);
            padding: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 0;
            overflow: hidden;
        }

        .calendar-cell:nth-child(7n) {
            border-right: none;
        }

        .calendar-cell:hover {
            background: var(--background-hover);
            z-index: 1;
        }

        .calendar-cell.other-month {
            opacity: 0.4;
            background: var(--background-secondary);
        }

        .calendar-cell.today {
            background: rgba(var(--primary-rgb), 0.05);
        }

        .calendar-cell.today .date-number {
            color: var(--primary-color);
            font-weight: 800;
        }

        .calendar-cell.selected {
            color: white !important;
            z-index: 1;
        }

        .calendar-cell.selected::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            background: var(--primary-color);
            border-radius: 10px;
            z-index: -1;
            box-shadow: 0 4px 10px rgba(var(--primary-rgb), 0.3);
            animation: selectedPop 0.2s ease-out;
        }

        @keyframes selectedPop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .calendar-cell.selected .date-number,
        .calendar-cell.selected .lunar-date,
        .calendar-cell.selected .holiday-name,
        .calendar-cell.selected .solar-term {
            color: white !important;
        }

        .calendar-cell.weekend .date-number {
            color: var(--error-color);
        }

        .calendar-cell.holiday {
            background: linear-gradient(to bottom right, rgba(239, 68, 68, 0.03), transparent);
        }

        .date-number {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 1px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .calendar-cell.today .date-number {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(var(--primary-rgb), 0.3);
        }

        .calendar-cell.selected .date-number {
            background: white;
            color: var(--primary-color) !important;
        }

        .lunar-date {
            font-size: 11px;
            color: var(--text-tertiary);
            text-align: center;
            margin-top: 1px;
            white-space: nowrap;
        }

        .holiday-name {
            font-size: 10px;
            color: var(--error-color);
            font-weight: 600;
            text-align: center;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        /* 信息面板样式 */
        .info-panel {
            margin-top: var(--spacing-md);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            flex-shrink: 0;
        }

        .info-card {
            background: var(--background-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            height: 150px;
            /* 固定高度 */
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--surface-shadow);
            border-color: var(--primary-light);
        }

        .info-card-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
        }

        .info-card-title i {
            color: var(--primary-color);
            font-size: 12px;
        }

        .info-card-content {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 12px;
            flex: 1;
            overflow: hidden;
            /* 默认隐藏超出部分，保持美观 */
        }

        #monthHolidays {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, 1fr);
            grid-auto-flow: column;
            /* 纵向排列，填满一列再填下一列 */
            gap: 0 10px;
        }

        #monthHolidays div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .info-highlight {
            color: var(--primary-color);
            font-weight: 700;
            background: rgba(var(--primary-rgb), 0.1);
            padding: 1px 4px;
            border-radius: 4px;
        }

        .info-date {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 14px;
        }

        /* 今日标签样式 */
        .today-badge {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            padding: 2px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 800;
            margin-top: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            letter-spacing: 1px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 12px rgba(var(--accent-rgb), 0.2);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
        }

        /* 年月日选择器样式 */
        .date-selector {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--background-tertiary);
            padding: 4px 8px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .date-input {
            padding: 4px;
            border: 1px solid transparent;
            border-radius: 6px;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            width: 50px;
            transition: all 0.2s;
        }

        #yearInput {
            width: 60px;
        }

        .date-input:hover {
            background: var(--background-primary);
            border-color: var(--border-light);
        }

        .date-input:focus {
            outline: none;
            background: var(--background-primary);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        }

        .date-selector span {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-xs);
            }

            .calendar-container {
                padding: var(--spacing-sm);
                border-radius: 12px;
            }

            .control-panel {
                padding: var(--spacing-sm);
                gap: var(--spacing-xs);
            }

            .date-controls {
                gap: 2px;
            }

            .control-btn {
                width: 32px;
                height: 32px;
                border-radius: 8px;
            }

            .date-selector {
                padding: 2px 4px;
            }

            .date-input {
                width: 40px;
                font-size: 12px;
            }

            #yearInput {
                width: 50px;
            }

            .info-panel {
                grid-template-columns: 1fr;
                gap: var(--spacing-xs);
            }

            .info-card {
                padding: var(--spacing-xs) var(--spacing-sm);
            }

            h1 {
                font-size: 18px;
                margin-bottom: var(--spacing-xs);
            }
        }

        /* 节气标记 */
        .solar-term {
            font-size: 10px;
            color: var(--accent-color);
            font-weight: 700;
            text-align: center;
            margin-top: 1px;
        }
    </style>
</head>

<body>
    <div class="calendar-container">
        <h1>
            <i class="fas fa-calendar-alt"></i>
            万年历
        </h1>

        <div class="control-panel">
            <div class="date-controls">
                <button class="control-btn" id="prevYear" title="上一月">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="control-btn" id="prevMonth" title="前一天">
                    <i class="fas fa-angle-left"></i>
                </button>

                <div class="date-selector">
                    <input type="number" class="date-input" id="yearInput" min="1900" max="2100">
                    <span>年</span>
                    <input type="number" class="date-input" id="monthInput" min="1" max="12">
                    <span>月</span>
                    <input type="number" class="date-input" id="dayInput" min="1" max="31">
                    <span>日</span>
                </div>

                <button class="control-btn" id="nextMonth" title="后一天">
                    <i class="fas fa-angle-right"></i>
                </button>
                <button class="control-btn" id="nextYear" title="下一月">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>

            <div class="quick-actions">
                <button class="control-btn today-btn" id="todayBtn">
                    <i class="fas fa-home"></i>
                    今天
                </button>
            </div>
        </div>

        <div class="calendar-grid">
            <div class="calendar-header">
                <div class="calendar-header-cell weekend">日</div>
                <div class="calendar-header-cell">一</div>
                <div class="calendar-header-cell">二</div>
                <div class="calendar-header-cell">三</div>
                <div class="calendar-header-cell">四</div>
                <div class="calendar-header-cell">五</div>
                <div class="calendar-header-cell weekend">六</div>
            </div>
            <div class="calendar-body" id="calendarBody">
                <!-- 日历单元格将通过JavaScript生成 -->
            </div>
        </div>

        <div class="info-panel">
            <div class="info-card">
                <div class="info-card-title">
                    <i class="fas fa-info-circle"></i>
                    选中日期信息
                </div>
                <div class="info-card-content" id="selectedDateInfo">
                    点击日期查看详细信息
                </div>
            </div>

            <div class="info-card">
                <div class="info-card-title">
                    <i class="fas fa-calendar-day"></i>
                    今日信息
                </div>
                <div class="info-card-content" id="todayInfo">
                    <!-- 今日信息将通过JavaScript生成 -->
                </div>
            </div>

            <div class="info-card">
                <div class="info-card-title">
                    <i class="fas fa-star"></i>
                    本月节日
                </div>
                <div class="info-card-content" id="monthHolidays">
                    <!-- 本月节日将通过JavaScript生成 -->
                </div>
            </div>
        </div>
    </div>

    <script src="../js/theme.js"></script>
    <script>
        // 万年历类
        class Calendar {
            // 农历大数据表 (1900-2100)
            // 每项数据：[闰月月份(4位), 农历各月大小(12位), 闰月大小(1位)]
            static LUNAR_DATA = [
                0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
                0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
                0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
                0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
                0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,
                0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5d0, 0x14573, 0x052d0, 0x0a9a8, 0x0e950, 0x06aa0,
                0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,
                0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b5a0, 0x195a6,
                0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570,
                0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0,
                0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5,
                0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930,
                0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530,
                0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45,
                0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0,
                0x14b63, 0x09370, 0x049f8, 0x04970, 0x064b0, 0x168a6, 0x0ea50, 0x06b20, 0x1a6c4, 0x0aae0,
                0x0a2e0, 0x0d2e3, 0x0c960, 0x0d557, 0x0d4a0, 0x0da50, 0x05d55, 0x056a0, 0x0a6d0, 0x055d4,
                0x052d0, 0x0a9b8, 0x0a950, 0x0b4a0, 0x0b6a6, 0x0ad50, 0x055a0, 0x0aba4, 0x0a5b0, 0x052b0,
                0x0b273, 0x06930, 0x07337, 0x06aa0, 0x0ad50, 0x14b55, 0x04b60, 0x0a570, 0x054e4, 0x0d160,
                0x0e968, 0x0d520, 0x0daa0, 0x16aa6, 0x056d0, 0x04ae0, 0x0a9d4, 0x0a2d0, 0x0d150, 0x0f252,
                0x0d520
            ];

            // 农历节日配置
            static LUNAR_HOLIDAYS = {
                '1-1': '春节', '1-15': '元宵节', '2-2': '龙抬头', '5-5': '端午节',
                '7-7': '七夕节', '8-15': '中秋节', '9-9': '重阳节', '12-8': '腊八节',
                '12-23': '小年'
            };

            static HOLIDAYS = {
                '1-1': '元旦', '2-14': '情人节', '3-8': '妇女节', '3-12': '植树节',
                '3-15': '消费者权益日', '4-1': '愚人节', '4-22': '世界地球日',
                '5-1': '劳动节', '5-4': '青年节', '5-12': '护士节',
                '6-1': '儿童节', '6-5': '世界环境日', '7-1': '建党节', '8-1': '建军节',
                '9-10': '教师节', '10-1': '国庆节', '10-31': '万圣节', '11-11': '光棍节',
                '12-24': '平安夜', '12-25': '圣诞节'
            };

            static SOLAR_TERMS = [
                { month: 2, day: 4, name: '立春' }, { month: 2, day: 19, name: '雨水' },
                { month: 3, day: 6, name: '惊蛰' }, { month: 3, day: 21, name: '春分' },
                { month: 4, day: 5, name: '清明' }, { month: 4, day: 20, name: '谷雨' },
                { month: 5, day: 6, name: '立夏' }, { month: 5, day: 21, name: '小满' },
                { month: 6, day: 6, name: '芒种' }, { month: 6, day: 21, name: '夏至' },
                { month: 7, day: 7, name: '小暑' }, { month: 7, day: 23, name: '大暑' },
                { month: 8, day: 8, name: '立秋' }, { month: 8, day: 23, name: '处暑' },
                { month: 9, day: 8, name: '白露' }, { month: 9, day: 23, name: '秋分' },
                { month: 10, day: 8, name: '寒露' }, { month: 10, day: 24, name: '霜降' },
                { month: 11, day: 8, name: '立冬' }, { month: 11, day: 22, name: '小雪' },
                { month: 12, day: 7, name: '大雪' }, { month: 12, day: 22, name: '冬至' },
                { month: 1, day: 6, name: '小寒' }, { month: 1, day: 20, name: '大寒' }
            ];

            constructor() {
                this.currentDate = new Date();
                this.selectedDate = new Date();
                this.viewYear = this.currentDate.getFullYear();
                this.viewMonth = this.currentDate.getMonth();

                // 缓存 DOM 引用
                this.dom = {
                    calendarBody: document.getElementById('calendarBody'),
                    yearInput: document.getElementById('yearInput'),
                    monthInput: document.getElementById('monthInput'),
                    dayInput: document.getElementById('dayInput'),
                    selectedDateInfo: document.getElementById('selectedDateInfo'),
                    todayInfo: document.getElementById('todayInfo'),
                    monthHolidays: document.getElementById('monthHolidays')
                };

                this.init();
            }

            init() {
                this.bindEvents();
                this.updateCalendar();
                this.updateTodayInfo();
                this.updateSelectedDateInfo();
                this.initInputValues();
            }

            // 绑定事件
            bindEvents() {
                // 控制按钮事件
                document.getElementById('prevYear').addEventListener('click', () => this.changeMonth(-1));
                document.getElementById('nextYear').addEventListener('click', () => this.changeMonth(1));
                document.getElementById('prevMonth').addEventListener('click', () => this.changeDay(-1));
                document.getElementById('nextMonth').addEventListener('click', () => this.changeDay(1));
                document.getElementById('todayBtn').addEventListener('click', () => this.goToToday());

                // 事件委托：处理日历单元格点击
                this.dom.calendarBody.addEventListener('click', (e) => {
                    const cell = e.target.closest('.calendar-cell');
                    if (cell && cell.dataset.date) {
                        const date = new Date(cell.dataset.date);
                        this.handleDateClick(date);
                    }
                });

                // 输入框事件
                this.dom.yearInput.addEventListener('change', (e) => {
                    const year = parseInt(e.target.value);
                    if (year >= 1900 && year <= 2100) {
                        this.viewYear = year;
                        this.updateSelectedDateWithView();
                        this.updateCalendar();
                        this.updateSelectedDateInfo();
                    }
                });

                this.dom.monthInput.addEventListener('change', (e) => {
                    const month = parseInt(e.target.value);
                    if (month >= 1 && month <= 12) {
                        this.viewMonth = month - 1;
                        this.updateSelectedDateWithView();
                        this.updateCalendar();
                        this.updateSelectedDateInfo();
                    }
                });

                this.dom.dayInput.addEventListener('change', (e) => {
                    const day = parseInt(e.target.value);
                    const daysInMonth = new Date(this.viewYear, this.viewMonth + 1, 0).getDate();

                    if (day >= 1 && day <= daysInMonth) {
                        this.selectedDate = new Date(this.viewYear, this.viewMonth, day);
                        this.updateCalendar();
                        this.updateSelectedDateInfo();
                    } else {
                        e.target.value = this.selectedDate.getDate();
                    }
                });

                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    switch (e.key) {
                        case 'ArrowLeft':
                            if (e.ctrlKey) this.changeMonth(-1); else this.changeDay(-1);
                            break;
                        case 'ArrowRight':
                            if (e.ctrlKey) this.changeMonth(1); else this.changeDay(1);
                            break;
                        case 'ArrowUp':
                            if (e.ctrlKey) this.changeYear(-1); else this.changeMonth(-1);
                            break;
                        case 'ArrowDown':
                            if (e.ctrlKey) this.changeYear(1); else this.changeMonth(1);
                            break;
                        case 'Home':
                            this.goToToday();
                            break;
                    }
                });
            }

            // 处理日期点击逻辑
            handleDateClick(date) {
                const isCurrentMonth = date.getMonth() === this.viewMonth;
                if (!isCurrentMonth) {
                    this.viewYear = date.getFullYear();
                    this.viewMonth = date.getMonth();
                }
                this.selectedDate = new Date(date);
                this.updateCalendar();
                this.updateSelectedDateInfo();
            }

            // 初始化输入框值
            initInputValues() {
                this.dom.yearInput.value = this.viewYear;
                this.dom.monthInput.value = this.viewMonth + 1;
                this.dom.dayInput.value = this.selectedDate.getDate();
            }

            // 改变日期
            changeDay(delta) {
                const newDate = new Date(this.selectedDate);
                newDate.setDate(this.selectedDate.getDate() + delta);
                this.selectedDate = newDate;
                this.viewYear = this.selectedDate.getFullYear();
                this.viewMonth = this.selectedDate.getMonth();
                this.updateCalendar();
                this.updateSelectedDateInfo();
            }

            // 改变年份
            changeYear(delta) {
                this.viewYear = Math.max(1900, Math.min(2100, this.viewYear + delta));
                this.updateSelectedDateWithView();
                this.updateCalendar();
                this.updateSelectedDateInfo();
            }

            // 改变月份
            changeMonth(delta) {
                this.viewMonth += delta;
                if (this.viewMonth < 0) {
                    this.viewMonth = 11;
                    this.viewYear -= 1;
                } else if (this.viewMonth > 11) {
                    this.viewMonth = 0;
                    this.viewYear += 1;
                }
                this.updateSelectedDateWithView();
                this.updateCalendar();
                this.updateSelectedDateInfo();
            }

            // 根据当前视图年份和月份，更新selectedDate（保持日不变，如果当月没有该日，则取最后一天）
            updateSelectedDateWithView() {
                const oldDay = this.selectedDate.getDate();
                const daysInNewMonth = new Date(this.viewYear, this.viewMonth + 1, 0).getDate();
                const newDay = Math.min(oldDay, daysInNewMonth);
                this.selectedDate = new Date(this.viewYear, this.viewMonth, newDay);
            }

            // 跳转到今天
            goToToday() {
                this.viewYear = this.currentDate.getFullYear();
                this.viewMonth = this.currentDate.getMonth();
                this.selectedDate = new Date(this.currentDate);
                this.updateCalendar();
                this.updateSelectedDateInfo();
            }

            // 更新日历
            updateCalendar() {
                this.updateInputValues();
                this.generateCalendar();
                this.updateMonthHolidays();
            }

            // 更新输入框值
            updateInputValues() {
                this.dom.yearInput.value = this.viewYear;
                this.dom.monthInput.value = this.viewMonth + 1;
                this.dom.dayInput.value = this.selectedDate.getDate();
            }

            // 生成日历
            generateCalendar() {
                const fragment = document.createDocumentFragment();
                const firstDay = new Date(this.viewYear, this.viewMonth, 1);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                // 生成42个单元格（6周）
                for (let i = 0; i < 42; i++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + i);
                    fragment.appendChild(this.createCalendarCell(cellDate));
                }

                this.dom.calendarBody.innerHTML = '';
                this.dom.calendarBody.appendChild(fragment);
            }

            // 创建日历单元格
            createCalendarCell(date) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                // 使用 dataset 存储日期信息，方便事件委托
                cell.dataset.date = date.toDateString();

                const isCurrentMonth = date.getMonth() === this.viewMonth;
                const isToday = this.isSameDate(date, this.currentDate);
                const isSelected = this.isSameDate(date, this.selectedDate);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;

                if (!isCurrentMonth) cell.classList.add('other-month');
                if (isToday) cell.classList.add('today');
                if (isSelected) cell.classList.add('selected');
                if (isWeekend) cell.classList.add('weekend');

                // 日期数字
                const dateNumber = document.createElement('div');
                dateNumber.className = 'date-number';
                dateNumber.textContent = date.getDate();
                cell.appendChild(dateNumber);

                if (isCurrentMonth) {
                    const lunarInfo = this.getLunarInfo(date);
                    if (lunarInfo) {
                        const lunarDate = document.createElement('div');
                        lunarDate.className = 'lunar-date';
                        lunarDate.textContent = lunarInfo;
                        cell.appendChild(lunarDate);
                    }

                    const h = this.getHoliday(date);
                    const s = this.getSolarTerm(date);
                    const dayEvents = new Set();
                    if (h) dayEvents.add(h);
                    if (s) {
                        let isDuplicate = false;
                        dayEvents.forEach(existing => {
                            if (existing.includes(s) || s.includes(existing)) isDuplicate = true;
                        });
                        if (!isDuplicate) dayEvents.add(s);
                    }

                    dayEvents.forEach(event => {
                        const eventEl = document.createElement('div');
                        // 如果是节气，使用 solar-term 类，否则使用 holiday-name 类
                        if (event === s) {
                            eventEl.className = 'solar-term';
                        } else {
                            cell.classList.add('holiday');
                            eventEl.className = 'holiday-name';
                        }
                        eventEl.textContent = event;
                        cell.appendChild(eventEl);
                    });
                }

                return cell;
            }

            // 判断是否为同一天
            isSameDate(date1, date2) {
                return date1.getFullYear() === date2.getFullYear() &&
                    date1.getMonth() === date2.getMonth() &&
                    date1.getDate() === date2.getDate();
            }

            // 获取农历信息（简化版本）
            getLunarInfo(date) {
                try {
                    const lunar = this.solarToLunar(date.getFullYear(), date.getMonth() + 1, date.getDate());
                    const monthNames = ['正', '二', '三', '四', '五', '六', '七', '八', '九', '十', '冬', '腊'];
                    const dayNames = ['初一', '初二', '初三', '初四', '初五', '初六', '初七', '初八', '初九', '初十',
                        '十一', '十二', '十三', '十四', '十五', '十六', '十七', '十八', '十九', '二十',
                        '廿一', '廿二', '廿三', '廿四', '廿五', '廿六', '廿七', '廿八', '廿九', '三十'];
                    return lunar.day === 1 ? `${monthNames[lunar.month - 1]}月` : dayNames[lunar.day - 1];
                } catch (e) { return null; }
            }

            // 获取完整农历信息（用于详细显示）
            getFullLunarInfo(date) {
                try {
                    const lunar = this.solarToLunar(date.getFullYear(), date.getMonth() + 1, date.getDate());
                    const monthNames = ['正月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '冬月', '腊月'];
                    const dayNames = ['初一', '初二', '初三', '初四', '初五', '初六', '初七', '初八', '初九', '初十',
                        '十一', '十二', '十三', '十四', '十五', '十六', '十七', '十八', '十九', '二十',
                        '廿一', '廿二', '廿三', '廿四', '廿五', '廿六', '廿七', '廿八', '廿九', '三十'];
                    const gzYear = this.getGanZhiYear(lunar.year);
                    const cnYear = this.toChineseYear(lunar.year);
                    return `${gzYear} (${cnYear}) ${monthNames[lunar.month - 1]}${dayNames[lunar.day - 1]}`;
                } catch (e) { return null; }
            }

            // 数字年份转中文年份 (繁体/规范写法)
            toChineseYear(year) {
                const chars = ['〇', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
                return year.toString().split('').map(digit => chars[parseInt(digit)]).join('') + '年';
            }

            // 获取天干地支年份
            getGanZhiYear(year) {
                const gan = ['庚', '辛', '壬', '癸', '甲', '乙', '丙', '丁', '戊', '己'];
                const zhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
                // 1900年是庚子年
                const offset = year - 1900;
                return gan[offset % 10] + zhi[offset % 12] + '年';
            }

            // 精准农历转换算法 (1900-2100)
            solarToLunar(year, month, day) {
                const iYear = parseInt(year);
                const iMonth = parseInt(month);
                const iDay = parseInt(day);

                // 基础日期：1900年1月31日是正月初一
                const baseDate = new Date(1900, 0, 31);
                const objDate = new Date(iYear, iMonth - 1, iDay);
                let offset = Math.floor((objDate.getTime() - baseDate.getTime()) / 86400000);

                let i, temp = 0;
                let lunarYear, lunarMonth, lunarDay;
                let isLeap = false;

                // 找年份
                for (i = 1900; i < 2101 && offset > 0; i++) {
                    temp = this.getLunarYearDays(i);
                    if (offset < temp) break;
                    offset -= temp;
                }
                lunarYear = i;

                // 找闰月
                const leapMonth = this.getLunarLeapMonth(lunarYear);

                // 找月份
                for (i = 1; i < 13 && offset >= 0; i++) {
                    // 闰月
                    if (leapMonth > 0 && i === (leapMonth + 1) && !isLeap) {
                        --i;
                        isLeap = true;
                        temp = this.getLunarLeapDays(lunarYear);
                    } else {
                        temp = this.getLunarMonthDays(lunarYear, i);
                    }

                    // 解除闰月状态
                    if (isLeap && i === (leapMonth + 1)) isLeap = false;

                    if (offset < temp) break;
                    offset -= temp;
                }
                lunarMonth = i;
                lunarDay = offset + 1;

                return {
                    year: lunarYear,
                    month: lunarMonth,
                    day: lunarDay,
                    isLeap: isLeap
                };
            }

            // 获取农历年总天数
            getLunarYearDays(year) {
                let i, sum = 348;
                for (i = 0x8000; i > 0x8; i >>= 1) {
                    sum += (Calendar.LUNAR_DATA[year - 1900] & i) ? 1 : 0;
                }
                return sum + this.getLunarLeapDays(year);
            }

            // 获取农历闰月天数
            getLunarLeapDays(year) {
                if (this.getLunarLeapMonth(year)) {
                    return (Calendar.LUNAR_DATA[year - 1900] & 0x10000) ? 30 : 29;
                }
                return 0;
            }

            // 获取农历闰哪个月
            getLunarLeapMonth(year) {
                return Calendar.LUNAR_DATA[year - 1900] & 0xf;
            }

            // 获取农历某月天数
            getLunarMonthDays(year, month) {
                return (Calendar.LUNAR_DATA[year - 1900] & (0x10000 >> month)) ? 30 : 29;
            }

            // 获取节日信息
            getHoliday(date) {
                const key = `${date.getMonth() + 1}-${date.getDate()}`;

                // 1. 特殊公历节日
                const specialHoliday = this.getSpecialHoliday(date);
                if (specialHoliday) return specialHoliday;

                // 2. 固定公历节日
                if (Calendar.HOLIDAYS[key]) return Calendar.HOLIDAYS[key];

                // 3. 农历节日 (使用精准算法)
                const lunar = this.solarToLunar(date.getFullYear(), date.getMonth() + 1, date.getDate());
                if (lunar && !lunar.isLeap) { // 闰月通常不过节
                    const lunarKey = `${lunar.month}-${lunar.day}`;
                    if (Calendar.LUNAR_HOLIDAYS[lunarKey]) return Calendar.LUNAR_HOLIDAYS[lunarKey];

                    // 特殊处理：除夕
                    if (lunar.month === 12) {
                        const monthDays = this.getLunarMonthDays(lunar.year, 12);
                        if (lunar.day === monthDays) {
                            return '除夕';
                        }
                    }
                }

                return null;
            }

            // 获取特殊节日（如第几个周几）
            getSpecialHoliday(date) {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dayOfWeek = date.getDay();
                // 母亲节：5月第二个星期日
                if (month === 5 && dayOfWeek === 0 && day === this.getNthWeekday(date.getFullYear(), 4, 0, 2)) return '母亲节';
                // 父亲节：6月第三个星期日
                if (month === 6 && dayOfWeek === 0 && day === this.getNthWeekday(date.getFullYear(), 5, 0, 3)) return '父亲节';
                return null;
            }

            // 获取某月第N个星期几的日期
            getNthWeekday(year, month, dayOfWeek, nth) {
                const firstDayOfWeek = new Date(year, month, 1).getDay();
                return 1 + (dayOfWeek - firstDayOfWeek + 7) % 7 + (nth - 1) * 7;
            }

            // 获取节气信息
            getSolarTerm(date) {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const term = Calendar.SOLAR_TERMS.find(t => t.month === month && t.day === day);
                return term ? term.name : null;
            }

            // 更新选中日期信息
            updateSelectedDateInfo() {
                const date = this.selectedDate;
                const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                const h = this.getHoliday(date);
                const s = this.getSolarTerm(date);
                const fullLunarInfo = this.getFullLunarInfo(date);

                const dayEvents = new Set();
                if (h) dayEvents.add(h);
                if (s) {
                    let isDuplicate = false;
                    dayEvents.forEach(existing => {
                        if (existing.includes(s) || s.includes(existing)) isDuplicate = true;
                    });
                    if (!isDuplicate) dayEvents.add(s);
                }

                let content = `<div><span class="info-date">${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${weekdays[date.getDay()]}</span></div>`;
                if (fullLunarInfo) content += `<div>农历：<span class="info-highlight">${fullLunarInfo}</span></div>`;

                dayEvents.forEach(event => {
                    const label = event === s ? '节气' : '节日';
                    content += `<div>${label}：<span class="info-highlight">${event}</span></div>`;
                });

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const compareDate = new Date(date);
                compareDate.setHours(0, 0, 0, 0);
                const daysDiff = Math.floor((compareDate - today) / 86400000);

                if (daysDiff === 0) content += `<div><span class="today-badge">今天</span></div>`;
                else if (daysDiff === 1) content += `<div style="color: var(--primary-color); margin-top: 4px; font-weight: 600;">明天</div>`;
                else if (daysDiff === -1) content += `<div style="color: var(--text-secondary); margin-top: 4px;">昨天</div>`;
                else if (daysDiff > 0) content += `<div style="color: var(--primary-color); margin-top: 4px;">${daysDiff}天后</div>`;
                else content += `<div style="color: var(--text-secondary); margin-top: 4px;">${Math.abs(daysDiff)}天前</div>`;

                this.dom.selectedDateInfo.innerHTML = content;
            }

            // 更新今日信息
            updateTodayInfo() {
                const today = this.currentDate;
                const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                const h = this.getHoliday(today);
                const s = this.getSolarTerm(today);
                const fullLunarInfo = this.getFullLunarInfo(today);

                const dayEvents = new Set();
                if (h) dayEvents.add(h);
                if (s) {
                    let isDuplicate = false;
                    dayEvents.forEach(existing => {
                        if (existing.includes(s) || s.includes(existing)) isDuplicate = true;
                    });
                    if (!isDuplicate) dayEvents.add(s);
                }

                let content = `<div><span class="info-date">${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日 ${weekdays[today.getDay()]}</span></div>`;
                if (fullLunarInfo) content += `<div>农历：<span class="info-highlight">${fullLunarInfo}</span></div>`;

                dayEvents.forEach(event => {
                    const label = event === s ? '今日节气' : '今日节日';
                    content += `<div>${label}：<span class="info-highlight">${event}</span></div>`;
                });

                this.dom.todayInfo.innerHTML = content;
            }

            // 更新本月节日
            updateMonthHolidays() {
                const holidays = [];
                const daysInMonth = new Date(this.viewYear, this.viewMonth + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(this.viewYear, this.viewMonth, day);
                    const h = this.getHoliday(date);
                    const s = this.getSolarTerm(date);

                    const dayEvents = new Set();
                    if (h) dayEvents.add(h);

                    if (s) {
                        let isDuplicate = false;
                        dayEvents.forEach(existing => {
                            if (existing.includes(s) || s.includes(existing)) isDuplicate = true;
                        });
                        if (!isDuplicate) dayEvents.add(s);
                    }

                    dayEvents.forEach(event => {
                        holidays.push(`${day}日 - ${event}`);
                    });
                }
                this.dom.monthHolidays.innerHTML = holidays.length > 0
                    ? holidays.map(h => `<div>${h}</div>`).join('')
                    : '<div style="color: var(--text-tertiary);">本月暂无特殊节日</div>';
            }
        }

        // 初始化万年历
        document.addEventListener('DOMContentLoaded', () => {
            new Calendar();
        });
    </script>
</body>

</html>