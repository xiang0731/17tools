<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代码格式化工具</title>
    <link rel="stylesheet" href="../css/theme.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettier/2.8.8/standalone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettier/2.8.8/parser-babel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettier/2.8.8/parser-html.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettier/2.8.8/parser-postcss.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettier/2.8.8/parser-typescript.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettier/2.8.8/parser-json.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettier/2.8.8/parser-yaml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettier/2.8.8/parser-markdown.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettier/2.8.8/parser-graphql.js"></script>
    <!-- 添加highlight.js库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/graphql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/ruby.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/swift.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/csharp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/shell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/sql.min.js"></script>
    <style>
        body {
            min-height: 100vh;
            padding: var(--spacing-lg);
            background-color: var(--background-primary);
            color: var(--text-primary);
            font-family: var(--font-family);
            margin: 0;
            overflow-x: hidden;
        }

        /* 标题样式 */
        h1 {
            text-align: center;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-xl) 0;
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        /* 主容器样式 */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xl);
            min-height: 70vh;
        }

        @media (max-width: 1024px) {
            .editor-container {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
            }

            body {
                padding: var(--spacing-md);
            }

            .container {
                padding: var(--spacing-lg);
            }
        }

        .code-area {
            display: flex;
            flex-direction: column;
            background: var(--background-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }

        .code-area:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .code-header {
            background: var(--background-tertiary);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            font-weight: 600;
            font-size: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .code-header i {
            color: var(--primary-color);
        }

        .language-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--background-secondary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .language-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex: 1;
            min-width: 200px;
        }

        .language-label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
            white-space: nowrap;
        }

        /* 代码编辑器容器 */
        .editor-wrapper {
            display: flex;
            flex: 1;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }

        /* 行号容器 */
        .line-numbers {
            width: 60px;
            background: var(--background-tertiary);
            border-right: 1px solid var(--border-color);
            padding: var(--spacing-md) 0;
            text-align: right;
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-tertiary);
            overflow: hidden;
            user-select: none;
            display: flex;
            flex-direction: column;
        }

        .line-numbers span {
            padding: 0 var(--spacing-sm);
            min-height: 20.8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        textarea {
            flex: 1;
            margin: 0;
            padding: var(--spacing-md);
            border: none;
            font-family: var(--font-mono);
            font-size: 14px;
            resize: none;
            overflow: auto;
            background: var(--background-primary);
            color: var(--text-primary);
            line-height: 1.6;
            outline: none;
            transition: background-color var(--transition-fast);
        }

        textarea::placeholder {
            color: var(--text-tertiary);
            font-style: italic;
        }

        /* 代码输出区域 */
        .code-output {
            flex: 1;
            overflow: auto;
            background: var(--background-primary);
            padding: var(--spacing-md);
        }

        .output-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.6;
        }

        .output-table td {
            vertical-align: top;
            padding: 0;
        }

        .output-line-number {
            width: 60px;
            text-align: right;
            padding-right: var(--spacing-sm) !important;
            color: var(--text-tertiary);
            background: var(--background-tertiary);
            border-right: 1px solid var(--border-color);
            user-select: none;
            font-size: 13px;
        }

        .output-line-code {
            padding-left: var(--spacing-md) !important;
            white-space: pre;
            color: var(--text-primary);
            background: var(--background-primary);
        }

        /* 按钮样式 */
        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .action-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            min-width: 80px;
            justify-content: center;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-inverse);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-success {
            background: var(--success-color);
            color: var(--text-inverse);
        }

        .btn-success:hover {
            background: var(--accent-hover);
        }

        .btn-info {
            background: var(--primary-color);
            color: var(--text-inverse);
        }

        .btn-info:hover {
            background: var(--primary-hover);
        }

        .btn-danger {
            background: var(--error-color);
            color: var(--text-inverse);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: var(--background-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--background-hover);
            border-color: var(--primary-color);
        }

        /* 选择器样式 */
        select {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--background-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-family);
            cursor: pointer;
            transition: all var(--transition-fast);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right var(--spacing-sm) center;
            background-size: 16px;
            padding-right: var(--spacing-xl);
            min-width: 150px;
        }

        select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        select:hover {
            border-color: var(--primary-color);
        }

        /* 语言检测指示器 */
        .language-indicator {
            background: var(--primary-light);
            color: var(--primary-color);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: var(--spacing-xs);
            border: 1px solid var(--primary-color);
        }

        .language-indicator.show {
            display: flex;
        }

        .language-indicator i {
            color: var(--primary-color);
        }

        /* 状态提示 */
        .status-message {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
        }

        .status-message.show {
            transform: translateX(0);
        }

        .status-success {
            background: var(--success-color);
            color: var(--text-inverse);
        }

        .status-error {
            background: var(--error-color);
            color: var(--text-inverse);
        }

        .status-info {
            background: var(--primary-color);
            color: var(--text-inverse);
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .processing {
            animation: pulse 1s infinite;
        }

        /* 空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            color: var(--text-tertiary);
            text-align: center;
            padding: var(--spacing-xl);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
            color: var(--text-tertiary);
        }

        .empty-state h3 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--text-secondary);
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        /* 高亮样式覆盖 */
        .hljs {
            background: var(--background-primary) !important;
            color: var(--text-primary) !important;
            padding: 0 !important;
        }

        pre,
        code {
            background: var(--background-primary) !important;
            color: var(--text-primary) !important;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .language-selector {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-sm);
            }

            .language-controls {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-sm);
            }

            .action-buttons {
                justify-content: center;
            }

            .action-button {
                flex: 1;
                min-width: auto;
            }

            h1 {
                font-size: 24px;
            }

            .line-numbers {
                width: 50px;
            }

            .output-line-number {
                width: 50px;
            }
        }

        /* 加载状态 */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <h1>
        <i class="fas fa-code"></i>
        代码格式化工具
    </h1>

    <div class="container">
        <div class="editor-container">
            <!-- 输入区域 -->
            <div class="code-area">
                <div class="code-header">
                    <i class="fas fa-edit"></i>
                    代码输入
                </div>
                <div class="language-selector">
                    <div class="language-controls">
                        <label class="language-label" for="language">
                            <i class="fas fa-cog"></i>
                            语言选择:
                        </label>
                        <select id="language">
                            <option value="auto" selected>🤖 自动检测</option>
                            <option value="babel">📄 JavaScript</option>
                            <option value="typescript">📘 TypeScript</option>
                            <option value="html">🌐 HTML</option>
                            <option value="css">🎨 CSS</option>
                            <option value="json">📋 JSON</option>
                            <option value="yaml">📊 YAML</option>
                            <option value="markdown">📝 Markdown</option>
                            <option value="graphql">🔗 GraphQL</option>
                            <option value="cpp-highlight">⚡ C/C++</option>
                            <option value="csharp-highlight">🔷 C#</option>
                            <option value="java-highlight">☕ Java</option>
                            <option value="python-highlight">🐍 Python</option>
                            <option value="go-highlight">🚀 Go</option>
                            <option value="rust-highlight">🦀 Rust</option>
                            <option value="swift-highlight">🍎 Swift</option>
                            <option value="php-highlight">🐘 PHP</option>
                            <option value="ruby-highlight">💎 Ruby</option>
                            <option value="shell-highlight">💻 Shell/Bash</option>
                            <option value="sql-highlight">🗃️ SQL</option>
                        </select>
                        <div id="detected-language" class="language-indicator">
                            <i class="fas fa-check-circle"></i>
                            <span id="language-name">JavaScript</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button id="copy-input-btn" class="action-button btn-secondary">
                            <i class="fas fa-copy"></i>
                            复制
                        </button>
                        <button id="download-input-btn" class="action-button btn-secondary">
                            <i class="fas fa-download"></i>
                            下载
                        </button>
                        <button id="clear-btn" class="action-button btn-danger">
                            <i class="fas fa-trash"></i>
                            清空
                        </button>
                    </div>
                </div>
                <div class="editor-wrapper">
                    <div id="input-line-numbers" class="line-numbers"></div>
                    <textarea id="input-code" placeholder="🚀 在此粘贴或输入您的代码...

💡 支持多种编程语言
📝 自动检测语言类型
✨ 智能格式化美化
🎯 语法高亮显示"></textarea>
                </div>
            </div>

            <!-- 输出区域 -->
            <div class="code-area">
                <div class="code-header">
                    <i class="fas fa-magic"></i>
                    格式化结果
                </div>
                <div class="language-selector">
                    <div class="action-buttons" style="width: 100%; justify-content: center;">
                        <button id="format-btn" class="action-button btn-primary">
                            <i class="fas fa-magic"></i>
                            格式化代码
                        </button>
                        <button id="copy-btn" class="action-button btn-success">
                            <i class="fas fa-copy"></i>
                            复制结果
                        </button>
                        <button id="download-btn" class="action-button btn-info">
                            <i class="fas fa-download"></i>
                            下载结果
                        </button>
                    </div>
                </div>
                <div class="editor-wrapper">
                    <div class="code-output">
                        <div class="empty-state" id="empty-state">
                            <i class="fas fa-code"></i>
                            <h3>等待格式化</h3>
                            <p>输入代码后点击"格式化代码"按钮</p>
                        </div>
                        <table class="output-table" id="output-table" style="display: none;">
                            <tbody>
                                <!-- 代码和行号将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 状态消息容器 -->
    <div id="status-message" class="status-message"></div>

    <script src="../js/theme.js"></script>
    <script>
        // 防抖动函数
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 状态提示功能
        function showStatus(message, type = 'info', duration = 3000) {
            const statusEl = document.getElementById('status-message');
            statusEl.className = `status-message status-${type}`;

            const iconMap = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'info': 'fas fa-info-circle'
            };

            statusEl.innerHTML = `<i class="${iconMap[type]}"></i> ${message}`;
            statusEl.classList.add('show');

            setTimeout(() => {
                statusEl.classList.remove('show');
            }, duration);
        }

        // 语言映射
        const languageMap = {
            'babel': 'JavaScript',
            'typescript': 'TypeScript',
            'html': 'HTML',
            'css': 'CSS',
            'json': 'JSON',
            'yaml': 'YAML',
            'markdown': 'Markdown',
            'graphql': 'GraphQL',
            'php-highlight': 'PHP',
            'python-highlight': 'Python',
            'java-highlight': 'Java',
            'ruby-highlight': 'Ruby',
            'go-highlight': 'Go',
            'swift-highlight': 'Swift',
            'csharp-highlight': 'C#',
            'cpp-highlight': 'C/C++',
            'rust-highlight': 'Rust',
            'shell-highlight': 'Shell/Bash',
            'sql-highlight': 'SQL',
            'auto': '自动检测'
        };

        // highlight.js语言映射
        const highlightLangMap = {
            'babel': 'javascript',
            'typescript': 'typescript',
            'html': 'xml',
            'css': 'css',
            'json': 'json',
            'yaml': 'yaml',
            'markdown': 'markdown',
            'graphql': 'graphql',
            'php-highlight': 'php',
            'python-highlight': 'python',
            'java-highlight': 'java',
            'ruby-highlight': 'ruby',
            'go-highlight': 'go',
            'swift-highlight': 'swift',
            'csharp-highlight': 'csharp',
            'cpp-highlight': 'cpp',
            'rust-highlight': 'rust',
            'shell-highlight': 'shell',
            'sql-highlight': 'sql'
        };

        // 文件扩展名映射
        const fileExtMap = {
            'babel': 'js',
            'typescript': 'ts',
            'html': 'html',
            'css': 'css',
            'json': 'json',
            'yaml': 'yaml',
            'markdown': 'md',
            'graphql': 'graphql',
            'php-highlight': 'php',
            'python-highlight': 'py',
            'java-highlight': 'java',
            'ruby-highlight': 'rb',
            'go-highlight': 'go',
            'swift-highlight': 'swift',
            'csharp-highlight': 'cs',
            'cpp-highlight': 'cpp',
            'rust-highlight': 'rs',
            'shell-highlight': 'sh',
            'sql-highlight': 'sql'
        };

        let lastDetectedLanguage = '';
        let isFormatting = false;

        // 事件监听器
        document.addEventListener('DOMContentLoaded', function () {
            const inputCode = document.getElementById('input-code');
            const languageSelect = document.getElementById('language');
            const formatBtn = document.getElementById('format-btn');
            const copyBtn = document.getElementById('copy-btn');
            const copyInputBtn = document.getElementById('copy-input-btn');
            const downloadBtn = document.getElementById('download-btn');
            const downloadInputBtn = document.getElementById('download-input-btn');
            const clearBtn = document.getElementById('clear-btn');

            // 绑定事件
            formatBtn.addEventListener('click', formatCode);
            copyBtn.addEventListener('click', copyCode);
            copyInputBtn.addEventListener('click', copyInputCode);
            downloadBtn.addEventListener('click', downloadCode);
            downloadInputBtn.addEventListener('click', downloadInputCode);
            clearBtn.addEventListener('click', clearCode);

            // 输入事件监听器
            inputCode.addEventListener('paste', handleInputChange);
            inputCode.addEventListener('input', debounce(handleInputChange, 300));
            inputCode.addEventListener('scroll', syncInputScroll);
            inputCode.addEventListener('input', updateInputLineNumbers);

            // 语言选择变化
            languageSelect.addEventListener('change', () => {
                const code = inputCode.value.trim();
                if (code) {
                    formatCode();
                }
                // 隐藏检测标签，除非是自动检测
                const detectedLanguageEl = document.getElementById('detected-language');
                if (languageSelect.value !== 'auto') {
                    detectedLanguageEl.classList.remove('show');
                }
            });

            // 初始化
            updateInputLineNumbers();
            inputCode.focus();

            // 同步输入区域滚动
            function syncInputScroll() {
                document.getElementById('input-line-numbers').scrollTop = inputCode.scrollTop;
            }

            // 更新输入区行号
            function updateInputLineNumbers() {
                const lineCount = inputCode.value.split('\n').length;
                let lineNumbers = '';
                for (let i = 1; i <= lineCount; i++) {
                    lineNumbers += `<span>${i}</span>`;
                }
                document.getElementById('input-line-numbers').innerHTML = lineNumbers;
            }

            // 检测语言
            function detectLanguage() {
                const code = inputCode.value.trim();
                if (!code || languageSelect.value !== 'auto') return;

                let detectedLanguage = 'babel'; // 默认为JavaScript

                // 简化的语言检测逻辑
                if ((code.startsWith('{') && code.endsWith('}')) || (code.startsWith('[') && code.endsWith(']'))) {
                    try {
                        JSON.parse(code);
                        detectedLanguage = 'json';
                    } catch (e) {
                        // 不是有效的JSON
                    }
                } else if (code.includes('<!DOCTYPE html>') || code.match(/<html.*>/i)) {
                    detectedLanguage = 'html';
                } else if (code.match(/[\w-]+\s*:\s*[^;]+;/) && code.includes('{') && !code.includes('function')) {
                    detectedLanguage = 'css';
                } else if (code.includes(':') && (code.includes('interface ') || code.includes('type ') || code.match(/:\s*(string|number|boolean|any)\b/))) {
                    detectedLanguage = 'typescript';
                } else if (code.includes('def ') && code.includes('print(')) {
                    detectedLanguage = 'python-highlight';
                } else if (code.includes('<?php')) {
                    detectedLanguage = 'php-highlight';
                }

                // 更新显示
                if (detectedLanguage !== lastDetectedLanguage) {
                    lastDetectedLanguage = detectedLanguage;
                    const detectedLanguageEl = document.getElementById('detected-language');
                    const languageNameEl = document.getElementById('language-name');

                    languageNameEl.textContent = languageMap[detectedLanguage];
                    detectedLanguageEl.classList.add('show');

                    setTimeout(() => {
                        if (languageSelect.value === 'auto') {
                            formatCode();
                        }
                    }, 100);
                }
            }

            function handleInputChange() {
                const code = inputCode.value.trim();
                updateInputLineNumbers();

                if (!code) {
                    // 清空输出
                    document.getElementById('empty-state').style.display = 'flex';
                    document.getElementById('output-table').style.display = 'none';
                    return;
                }

                if (languageSelect.value === 'auto') {
                    detectLanguage();
                }
            }
        });

        // 格式化代码主函数
        async function formatCode() {
            if (isFormatting) return;

            const inputElement = document.getElementById('input-code');
            const code = inputElement.value.trim();

            if (!code) {
                showStatus('请输入要格式化的代码', 'error');
                return;
            }

            isFormatting = true;
            const formatBtn = document.getElementById('format-btn');
            const originalText = formatBtn.innerHTML;
            formatBtn.innerHTML = '<span class="loading"></span> 格式化中...';
            formatBtn.disabled = true;

            try {
                const selectedLanguage = document.getElementById('language').value;
                const language = selectedLanguage === 'auto' ? lastDetectedLanguage || 'babel' : selectedLanguage;

                let formattedCode = '';

                // 根据语言类型进行格式化
                switch (language) {
                    case 'babel':
                    case 'typescript':
                        try {
                            formattedCode = prettier.format(code, {
                                parser: language === 'typescript' ? 'typescript' : 'babel',
                                plugins: prettierPlugins,
                                singleQuote: true,
                                trailingComma: 'es5',
                                tabWidth: 2,
                                semi: true
                            });
                        } catch (error) {
                            throw new Error(`JavaScript/TypeScript 格式化错误: ${error.message}`);
                        }
                        break;

                    case 'html':
                        try {
                            formattedCode = prettier.format(code, {
                                parser: 'html',
                                plugins: prettierPlugins,
                                tabWidth: 2,
                                htmlWhitespaceSensitivity: 'css'
                            });
                        } catch (error) {
                            throw new Error(`HTML 格式化错误: ${error.message}`);
                        }
                        break;

                    case 'css':
                        try {
                            formattedCode = prettier.format(code, {
                                parser: 'css',
                                plugins: prettierPlugins,
                                tabWidth: 2
                            });
                        } catch (error) {
                            throw new Error(`CSS 格式化错误: ${error.message}`);
                        }
                        break;

                    case 'json':
                        try {
                            const parsed = JSON.parse(code);
                            formattedCode = JSON.stringify(parsed, null, 2);
                        } catch (error) {
                            throw new Error(`JSON 格式化错误: ${error.message}`);
                        }
                        break;

                    case 'yaml':
                        try {
                            formattedCode = prettier.format(code, {
                                parser: 'yaml',
                                plugins: prettierPlugins,
                                tabWidth: 2
                            });
                        } catch (error) {
                            // YAML格式化失败时保持原样
                            formattedCode = code;
                        }
                        break;

                    case 'markdown':
                        try {
                            formattedCode = prettier.format(code, {
                                parser: 'markdown',
                                plugins: prettierPlugins,
                                tabWidth: 2,
                                proseWrap: 'preserve'
                            });
                        } catch (error) {
                            formattedCode = code;
                        }
                        break;

                    case 'graphql':
                        try {
                            formattedCode = prettier.format(code, {
                                parser: 'graphql',
                                plugins: prettierPlugins,
                                tabWidth: 2
                            });
                        } catch (error) {
                            formattedCode = code;
                        }
                        break;

                    default:
                        // 对于不支持prettier格式化的语言，保持原样但进行基本的缩进处理
                        formattedCode = code.split('\n').map(line => line.trim()).join('\n');
                        break;
                }

                // 更新输出显示
                updateOutputDisplay(formattedCode, language);
                showStatus('代码格式化完成！', 'success');

            } catch (error) {
                console.error('格式化失败:', error);
                showStatus(error.message || '格式化失败，请检查代码语法', 'error');
            } finally {
                isFormatting = false;
                formatBtn.innerHTML = originalText;
                formatBtn.disabled = false;
            }
        }

        // 更新输出显示
        function updateOutputDisplay(formattedCode, language) {
            const emptyState = document.getElementById('empty-state');
            const outputTable = document.getElementById('output-table');

            emptyState.style.display = 'none';
            outputTable.style.display = 'table';

            const lines = formattedCode.split('\n');
            const tbody = outputTable.querySelector('tbody') || outputTable.createTBody();
            tbody.innerHTML = '';

            lines.forEach((line, index) => {
                const tr = document.createElement('tr');

                // 行号
                const numberCell = document.createElement('td');
                numberCell.className = 'output-line-number';
                numberCell.textContent = index + 1;
                tr.appendChild(numberCell);

                // 代码
                const codeCell = document.createElement('td');
                codeCell.className = 'output-line-code';

                const codeElement = document.createElement('code');
                codeElement.textContent = line;
                codeElement.className = `language-${highlightLangMap[language] || 'plaintext'}`;
                codeCell.appendChild(codeElement);

                tr.appendChild(codeCell);
                tbody.appendChild(tr);
            });

            // 应用语法高亮
            document.querySelectorAll('.output-line-code code').forEach(block => {
                hljs.highlightElement(block);
            });
        }

        // 复制功能
        function copyCode() {
            const outputTable = document.getElementById('output-table');
            if (outputTable.style.display === 'none') {
                showStatus('没有可复制的格式化结果', 'error');
                return;
            }

            const codes = Array.from(document.querySelectorAll('.output-line-code')).map(cell => cell.textContent);
            const formattedCode = codes.join('\n');

            navigator.clipboard.writeText(formattedCode).then(() => {
                showStatus('格式化结果已复制到剪贴板', 'success');
            }).catch(() => {
                showStatus('复制失败，请手动选择复制', 'error');
            });
        }

        function copyInputCode() {
            const inputCode = document.getElementById('input-code').value;
            if (!inputCode.trim()) {
                showStatus('输入框为空', 'error');
                return;
            }

            navigator.clipboard.writeText(inputCode).then(() => {
                showStatus('输入代码已复制到剪贴板', 'success');
            }).catch(() => {
                showStatus('复制失败，请手动选择复制', 'error');
            });
        }

        // 下载功能
        function downloadCode() {
            const outputTable = document.getElementById('output-table');
            if (outputTable.style.display === 'none') {
                showStatus('没有可下载的格式化结果', 'error');
                return;
            }

            const codes = Array.from(document.querySelectorAll('.output-line-code')).map(cell => cell.textContent);
            const formattedCode = codes.join('\n');
            const language = document.getElementById('language').value === 'auto' ? lastDetectedLanguage : document.getElementById('language').value;
            const extension = fileExtMap[language] || 'txt';

            downloadFile(formattedCode, `formatted-code.${extension}`);
        }

        function downloadInputCode() {
            const inputCode = document.getElementById('input-code').value;
            if (!inputCode.trim()) {
                showStatus('输入框为空', 'error');
                return;
            }

            const language = document.getElementById('language').value === 'auto' ? lastDetectedLanguage : document.getElementById('language').value;
            const extension = fileExtMap[language] || 'txt';

            downloadFile(inputCode, `input-code.${extension}`);
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatus(`文件 ${filename} 下载成功`, 'success');
        }

        // 清空功能
        function clearCode() {
            document.getElementById('input-code').value = '';
            document.getElementById('input-line-numbers').innerHTML = '<span>1</span>';
            document.getElementById('empty-state').style.display = 'flex';
            document.getElementById('output-table').style.display = 'none';
            document.getElementById('detected-language').classList.remove('show');
            lastDetectedLanguage = '';
            showStatus('已清空所有内容', 'info');
            document.getElementById('input-code').focus();
        }
    </script>
</body>

</html>